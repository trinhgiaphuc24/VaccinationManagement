{% extends 'admin/base_site.html' %}

{% block content %}
<h1>THỐNG KÊ TIÊM CHỦNG</h1>

<!-- Bộ lọc thời gian -->
<form method="get">
    <label for="time_filter">Chọn kiểu thống kê:</label>
    <select name="time_filter" id="time_filter">
        {% if time_filter == 'month' %}
            <option value="month" selected>Tháng</option>
        {% else %}
            <option value="month">Tháng</option>
        {% endif %}

        {% if time_filter == 'quarter' %}
            <option value="quarter" selected>Quý</option>
        {% else %}
            <option value="quarter">Quý</option>
        {% endif %}

        {% if time_filter == 'year' %}
            <option value="year" selected>Năm</option>
        {% else %}
            <option value="year">Năm</option>
        {% endif %}
    </select>

    <label for="year">Năm:</label>
    <input type="number" name="year" id="year" value="{{ year }}" min="2000" max="2100">

    <!-- Chỉ hiển thị combobox chọn tháng khi time_filter là 'month' -->
    {% if time_filter == 'month' %}
    <label for="period" id="period_label">Tháng:</label>
    <select name="period" id="period">
        {% for i in '123456789101112' %}
        {% if period == i %}
            <option value="{{ i }}" selected>Tháng {{ i }}</option>
        {% else %}
            <option value="{{ i }}">Tháng {{ i }}</option>
        {% endif %}
        {% endfor %}
    </select>
    {% endif %}

    <button type="submit">Lọc</button>
</form>

<h2>Thống kê trong {{ period_label }}</h2>

<!-- Các nút để chọn biểu đồ -->
<div style="margin-bottom: 20px;">
    <button id="showVaccinatedChart" style="padding: 10px 20px; margin-right: 10px;">Số lượng hồ sơ đã tiêm</button>
    <button id="showCompletionChart" style="padding: 10px 20px; margin-right: 10px;">Tỷ lệ hoàn thành lịch tiêm</button>
    <button id="showVaccineChart" style="padding: 10px 20px;">Số lượng vắc-xin theo loại</button>
</div>

<!-- Container chứa các biểu đồ -->
<div id="chartsContainer">
    <!-- Biểu đồ số lượng hồ sơ đã tiêm -->
    <div id="vaccinatedChartContainer" style="display: none;">
        <h3 style="text-align: center;">Số lượng hồ sơ đã tiêm</h3>
        <div style="width: 70%; margin: 0 auto;">
            <canvas id="vaccinatedChart"></canvas>
        </div>
    </div>

    <!-- Biểu đồ tỷ lệ hoàn thành lịch tiêm -->
    <div id="completionChartContainer" style="display: none;">
        <h3 style="text-align: center;">Tỷ lệ hoàn thành lịch tiêm</h3>
        <div style="width: 70%; margin: 0 auto;">
            <canvas id="completionRateChart"></canvas>
        </div>
    </div>

    <!-- Biểu đồ số lượng vắc-xin theo loại -->
    <div id="vaccineChartContainer" style="display: none;">
        <h3 style="text-align: center;">Số lượng vắc-xin theo loại</h3>
        <div style="width: 70%; margin: 0 auto;">
            <canvas id="vaccineChart"></canvas>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Dữ liệu từ backend
    const labels = {{ labels|safe }};
    const vaccinatedData = {{ vaccinated_data|safe }};
    const completionData = {{ completion_data|safe }};
    const vaccineStats = {{ vaccine_stats|safe }};

    // Khởi tạo các biểu đồ
    let vaccinatedChartInstance, completionChartInstance, vaccineChartInstance;

    // Biểu đồ số lượng hồ sơ đã tiêm
    const vaccinatedCtx = document.getElementById('vaccinatedChart');
    if (vaccinatedCtx) {
        vaccinatedChartInstance = new Chart(vaccinatedCtx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Số lượng hồ sơ đã tiêm',
                    data: vaccinatedData,
                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Số lượng'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Thời gian'
                        }
                    }
                }
            }
        });
    }

    // Biểu đồ tỷ lệ hoàn thành lịch tiêm
    const completionRateCtx = document.getElementById('completionRateChart');
    if (completionRateCtx) {
        completionChartInstance = new Chart(completionRateCtx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Tỷ lệ hoàn thành (%)',
                    data: completionData,
                    backgroundColor: 'rgba(255, 99, 132, 0.6)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        title: {
                            display: true,
                            text: 'Tỷ lệ (%)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Thời gian'
                        }
                    }
                }
            }
        });
    }

    // Biểu đồ số lượng vắc-xin theo loại
    const vaccineCtx = document.getElementById('vaccineChart');
    if (vaccineCtx) {
        const vaccineDatasets = Object.keys(vaccineStats).map((vaccineName, index) => {
            const colors = [
                'rgba(255, 99, 132, 0.6)',
                'rgba(54, 162, 235, 0.6)',
                'rgba(255, 206, 86, 0.6)',
                'rgba(75, 192, 192, 0.6)',
                'rgba(153, 102, 255, 0.6)'
            ];
            const color = colors[index % colors.length];
            return {
                label: vaccineName,
                data: vaccineStats[vaccineName],
                backgroundColor: color,
                borderColor: color.replace('0.6', '1'),
                borderWidth: 1
            };
        });

        vaccineChartInstance = new Chart(vaccineCtx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: vaccineDatasets
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Số lượng'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Thời gian'
                        }
                    }
                }
            }
        });
    }

    // Logic ẩn/hiện biểu đồ
    const vaccinatedChartContainer = document.getElementById('vaccinatedChartContainer');
    const completionChartContainer = document.getElementById('completionChartContainer');
    const vaccineChartContainer = document.getElementById('vaccineChartContainer');

    const showVaccinatedChartBtn = document.getElementById('showVaccinatedChart');
    const showCompletionChartBtn = document.getElementById('showCompletionChart');
    const showVaccineChartBtn = document.getElementById('showVaccineChart');

    // Hiển thị biểu đồ đầu tiên mặc định
    vaccinatedChartContainer.style.display = 'block';

    // Xử lý sự kiện click cho từng nút
    showVaccinatedChartBtn.addEventListener('click', () => {
        vaccinatedChartContainer.style.display = 'block';
        completionChartContainer.style.display = 'none';
        vaccineChartContainer.style.display = 'none';
        vaccinatedChartInstance.resize(); // Cập nhật kích thước biểu đồ
    });

    showCompletionChartBtn.addEventListener('click', () => {
        vaccinatedChartContainer.style.display = 'none';
        completionChartContainer.style.display = 'block';
        vaccineChartContainer.style.display = 'none';
        completionChartInstance.resize(); // Cập nhật kích thước biểu đồ
    });

    showVaccineChartBtn.addEventListener('click', () => {
        vaccinatedChartContainer.style.display = 'none';
        completionChartContainer.style.display = 'none';
        vaccineChartContainer.style.display = 'block';
        vaccineChartInstance.resize(); // Cập nhật kích thước biểu đồ
    });

    // Ẩn/hiện dropdown tháng dựa trên kiểu thống kê
    const timeFilter = document.getElementById('time_filter');
    const periodLabel = document.getElementById('period_label');
    const periodSelect = document.getElementById('period');

    timeFilter.addEventListener('change', function() {
        if (this.value === 'year' || this.value === 'quarter') {
            // Ẩn combobox khi chọn "year" hoặc "quarter"
            if (periodLabel && periodSelect) {
                periodLabel.style.display = 'none';
                periodSelect.style.display = 'none';
            }
        } else {
            // Hiện combobox khi chọn "month"
            if (periodLabel && periodSelect) {
                periodLabel.style.display = 'inline-block';
                periodSelect.style.display = 'inline-block';
                periodLabel.textContent = 'Tháng:';
                periodSelect.innerHTML = '';
                for (let i = 1; i <= 12; i++) {
                    const selected = i == {{ period }} ? 'selected' : '';
                    periodSelect.innerHTML += `<option value="${i}" ${selected}>Tháng ${i}</option>`;
                }
            }
        }
    });

    // Khởi tạo trạng thái ban đầu
    if (timeFilter.value === 'year' || timeFilter.value === 'quarter') {
        if (periodLabel && periodSelect) {
            periodLabel.style.display = 'none';
            periodSelect.style.display = 'none';
        }
    } else {
        if (periodLabel && periodSelect) {
            periodLabel.style.display = 'inline-block';
            periodSelect.style.display = 'inline-block';
            periodLabel.textContent = 'Tháng:';
        }
    }
</script>

{% endblock %}